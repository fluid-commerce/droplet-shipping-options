<% content_for :title, "Exigo Settings" %>

<%= turbo_frame_tag "shipping_content" do %>
<div class="max-w-4xl mx-auto py-8 px-4">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Exigo Integration Settings</h1>
    <p class="text-gray-600">Configure your Exigo database credentials and free shipping for subscribers</p>
  </div>

  <%= form_with url: exigo_setting_path(dri: params[:dri]),
                method: :patch,
                local: true,
                class: "space-y-8" do |f| %>

    <!-- Exigo DB Credentials -->
    <div class="bg-white shadow-sm rounded-xl border border-gray-200 p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-gray-900">DB Credentials</h2>
        <button type="button" id="test-connection-btn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 focus:ring-4 focus:ring-green-200 transition-colors">
          <i class="fa-solid fa-plug mr-2"></i>
          Test Connection
        </button>
      </div>

      <div id="connection-result" class="hidden mb-4"></div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Server -->
        <div class="md:col-span-2">
          <%= label_tag "company[exigo_db_server]", "Database Server", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= text_field_tag "company[exigo_db_server]",
                             @company.settings&.dig("exigo_db_server"),
                             class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",
                             placeholder: "myserver.database.windows.net" %>
          <p class="mt-1 text-sm text-gray-500">SQL Server hostname or IP address</p>
        </div>

        <!-- Database -->
        <div>
          <%= label_tag "company[exigo_db_name]", "Database Name", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= text_field_tag "company[exigo_db_name]",
                             @company.settings&.dig("exigo_db_name"),
                             class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",
                             placeholder: "ExigoDB" %>
          <p class="mt-1 text-sm text-gray-500">Name of the Exigo database</p>
        </div>

        <!-- User -->
        <div>
          <%= label_tag "company[exigo_db_user]", "Database User", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= text_field_tag "company[exigo_db_user]",
                             @company.settings&.dig("exigo_db_user"),
                             class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",
                             placeholder: "username" %>
          <p class="mt-1 text-sm text-gray-500">Database username</p>
        </div>

        <!-- Password -->
        <div class="md:col-span-2">
          <%= label_tag "company[exigo_db_password]", "Database Password", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= password_field_tag "company[exigo_db_password]",
                                 @company.settings&.dig("exigo_db_password"),
                                 class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",
                                 placeholder: "••••••••" %>
          <p class="mt-1 text-sm text-gray-500">Database password (encrypted in storage)</p>
        </div>

        <!-- Subscription ID -->
        <div class="md:col-span-2">
          <%= label_tag "company[exigo_subscription_id]", "Subscription ID", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= text_field_tag "company[exigo_subscription_id]",
                             @company.exigo_subscription_id || "9",
                             class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",
                             placeholder: "9" %>
          <p class="mt-1 text-sm text-gray-500">The subscription ID to check for active memberships</p>
        </div>
      </div>
    </div>

    <!-- Free Shipping Feature -->
    <div class="bg-gradient-to-r from-purple-50 to-pink-50 shadow-sm rounded-xl border-2 border-purple-300 p-6">
      <div class="flex items-start">
        <div class="flex items-center h-5 mt-1">
          <%= check_box_tag "company[free_shipping_for_subscribers]",
                            "1",
                            @company.free_shipping_enabled?,
                            class: "w-5 h-5 text-purple-600 border-purple-300 rounded focus:ring-purple-500" %>
        </div>
        <div class="ml-4 flex-1">
          <%= label_tag "company[free_shipping_for_subscribers]",
                        "Enable Free Shipping for Exigo Subscribers",
                        class: "block text-lg font-semibold text-purple-900 mb-3" %>

          <div class="space-y-3 text-sm text-purple-800">
            <p class="font-medium">When enabled, this feature will:</p>
            <ul class="list-disc list-inside space-y-2 ml-2">
              <li>Check if customers have an active Exigo subscription when they log in</li>
              <li>Show special "Free for Subscribers" shipping methods only to subscribed customers</li>
              <li>Automatically set shipping cost to $0 for subscriber-only shipping methods</li>
              <li>Cache subscription status for 5 minutes to improve performance</li>
            </ul>
          </div>

          <div class="mt-4 p-4 bg-white/60 rounded-lg border border-purple-200">
            <p class="text-xs text-purple-700">
              <strong>Note:</strong> Make sure to mark your desired shipping methods as
              "Free for Subscribers" when creating or editing them. Only those methods will be free.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Save Button -->
    <div class="flex justify-between items-center">
      <%= link_to "Cancel", shipping_options_path(dri: params[:dri]),
                  class: "px-6 py-2 text-gray-700 hover:text-gray-900 font-medium" %>
      <%= submit_tag "Save Settings",
                     class: "px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 transition-colors" %>
    </div>
  <% end %>

  <!-- Help Section -->
  <div class="mt-8 p-6 bg-blue-50 rounded-xl border border-blue-200">
    <h3 class="text-sm font-semibold text-blue-900 mb-3">
      ℹ️ How to get your Exigo database credentials
    </h3>
    <ol class="text-sm text-blue-800 space-y-2 list-decimal list-inside">
      <li>Contact your Exigo account manager to request database access</li>
      <li>Request read-only credentials for SQL Server access</li>
      <li>Fill in the Server, Database, User, and Password fields above</li>
      <li>Click "Test Connection" to verify the credentials work</li>
      <li>Ensure your server IP is whitelisted in Exigo's firewall</li>
    </ol>
  </div>
</div>

<script>
function initializeTestConnection() {
  const testBtn = document.getElementById('test-connection-btn');
  if (!testBtn) {
    console.log('Test connection button not found');
    return;
  }

  // Remove existing listener to prevent duplicates
  if (testBtn._testConnectionHandler) {
    testBtn.removeEventListener('click', testBtn._testConnectionHandler);
  }

  // Define the handler
  const handler = async function(e) {
    e.preventDefault();
    console.log('Test connection button clicked');

    const resultDiv = document.getElementById('connection-result');
    const originalBtnText = testBtn.innerHTML;

    // Get form values
    const server = document.querySelector('[name="company[exigo_db_server]"]')?.value;
    const database = document.querySelector('[name="company[exigo_db_name]"]')?.value;
    const user = document.querySelector('[name="company[exigo_db_user]"]')?.value;
    const password = document.querySelector('[name="company[exigo_db_password]"]')?.value;

    console.log('Form values:', { server, database, user, password: password ? '***' : null });

    // Validate fields
    if (!server || !database || !user || !password) {
      resultDiv.className = 'p-4 mb-4 bg-red-50 border border-red-200 rounded-lg';
      resultDiv.innerHTML = '<p class="text-sm text-red-800"><i class="fa-solid fa-xmark mr-2"></i>Please fill in all database fields</p>';
      resultDiv.classList.remove('hidden');
      return;
    }

    // Show loading
    testBtn.disabled = true;
    testBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Testing...';
    resultDiv.className = 'p-4 mb-4 bg-blue-50 border border-blue-200 rounded-lg';
    resultDiv.innerHTML = '<p class="text-sm text-blue-800"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>Connecting to database...</p>';
    resultDiv.classList.remove('hidden');

    try {
      // Get CSRF token
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content ||
                       document.querySelector('[name="csrf-token"]')?.content;

      console.log('CSRF token found:', !!csrfToken);

      const url = '<%= test_connection_exigo_setting_path(dri: params[:dri]) %>';
      console.log('Fetching URL:', url);

      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken,
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          server: server,
          database: database,
          user: user,
          password: password
        })
      });

      console.log('Response status:', response.status);

      const data = await response.json();
      console.log('Response data:', data);

      if (data.success) {
        resultDiv.className = 'p-4 mb-4 bg-green-50 border border-green-200 rounded-lg';
        resultDiv.innerHTML = `
          <div class="flex items-start">
            <i class="fa-solid fa-check-circle text-green-600 mt-0.5 mr-3"></i>
            <div class="flex-1">
              <p class="text-sm font-semibold text-green-900 mb-1">Connection Successful!</p>
              <p class="text-xs text-green-700">${data.message || 'Connected to Exigo database successfully'}</p>
            </div>
          </div>
        `;
      } else {
        resultDiv.className = 'p-4 mb-4 bg-red-50 border border-red-200 rounded-lg';
        resultDiv.innerHTML = `
          <div class="flex items-start">
            <i class="fa-solid fa-xmark-circle text-red-600 mt-0.5 mr-3"></i>
            <div class="flex-1">
              <p class="text-sm font-semibold text-red-900 mb-1">Connection Failed</p>
              <p class="text-xs text-red-700">${data.error || 'Could not connect to database'}</p>
            </div>
          </div>
        `;
      }
    } catch (error) {
      console.error('Test connection error:', error);
      resultDiv.className = 'p-4 mb-4 bg-red-50 border border-red-200 rounded-lg';
      resultDiv.innerHTML = `
        <div class="flex items-start">
          <i class="fa-solid fa-xmark-circle text-red-600 mt-0.5 mr-3"></i>
          <div class="flex-1">
            <p class="text-sm font-semibold text-red-900 mb-1">Connection Error</p>
            <p class="text-xs text-red-700">${error.message}</p>
          </div>
        </div>
      `;
    } finally {
      testBtn.disabled = false;
      testBtn.innerHTML = originalBtnText;
    }
  };

  // Store the handler and add listener
  testBtn._testConnectionHandler = handler;
  testBtn.addEventListener('click', handler);
  console.log('Test connection handler attached');
}

// Initialize on various events to ensure it works with Turbo
document.addEventListener('DOMContentLoaded', initializeTestConnection);
document.addEventListener('turbo:load', initializeTestConnection);
document.addEventListener('turbo:frame-load', function(e) {
  if (e.target.id === 'shipping_content') {
    setTimeout(initializeTestConnection, 100);
  }
});
</script>
<% end %>
