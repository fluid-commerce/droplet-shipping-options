<%= turbo_frame_tag "shipping_content" do %>
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 max-w-4xl mx-auto">
    <div class="mb-8">
      <h1 class="text-2xl font-bold text-gray-900 mb-2">Import Rate Tables from CSV</h1>
      <p class="text-gray-600">Upload a CSV file to bulk import shipping rates for your methods.</p>
    </div>

    <!-- Toast notification for auto-correctable errors -->
    <% if flash[:all_auto_correctable] && flash[:correction_summary] %>
      <div id="auto-correct-toast" class="fixed top-4 right-4 z-50 bg-yellow-50 border-2 border-yellow-400 rounded-lg shadow-lg p-6 max-w-md">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <i class="fa-solid fa-lightbulb text-yellow-600 text-xl"></i>
          </div>
          <div class="ml-3 flex-1">
            <h3 class="text-sm font-semibold text-yellow-900 mb-2">
              Auto-Correctable Errors Found
            </h3>
            <p class="text-sm text-yellow-800 mb-3">
              All errors in your CSV can be automatically corrected. The following values exceed the maximum allowed and will be adjusted to the upper bound:
            </p>
            <div class="mb-4 max-h-48 overflow-y-auto text-xs text-yellow-800 space-y-1">
              <% flash[:correction_summary].each do |correction| %>
                <div class="bg-yellow-100 p-2 rounded">
                  <strong>Row <%= correction[:row] %></strong> - <%= correction[:field].to_s.humanize %>: 
                  <%= correction[:original] %> â†’ <strong><%= correction[:corrected] %></strong>
                </div>
              <% end %>
            </div>
            <div class="flex space-x-3">
              <%= button_tag "Yes, Apply Corrections", type: "button", 
                  class: "px-4 py-2 text-sm font-medium text-white bg-yellow-600 hover:bg-yellow-700 rounded-lg transition-colors", 
                  onclick: "confirmAutoCorrections()" %>
              <%= button_tag "No, Cancel", type: "button", 
                  class: "px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors", 
                  onclick: "dismissToast()" %>
            </div>
          </div>
          <button type="button" onclick="dismissToast()" class="ml-4 text-yellow-600 hover:text-yellow-800">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>
      </div>
    <% end %>

  <% if (flash[:alert] || flash[:errors] || flash[:row_errors]) && !flash[:all_auto_correctable] %>
    <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
      <div class="flex">
        <div class="flex-shrink-0">
          <i class="fa-solid fa-exclamation-triangle text-red-400"></i>
        </div>
        <div class="ml-3 flex-1">
          <% if flash[:alert] %>
            <h3 class="text-sm font-medium text-red-800 mb-2">
              <%= flash[:alert] %>
            </h3>
          <% end %>
          
          <% if flash[:errors].present? %>
            <div class="mt-2 text-sm text-red-700">
              <ul class="list-disc list-inside space-y-1">
                <% flash[:errors].each do |error| %>
                  <li><%= error %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <% if flash[:row_errors].present? %>
            <div class="mt-3">
              <h4 class="text-sm font-medium text-red-800 mb-2">
                Import Errors (<%= flash[:row_errors].count %> row(s) with issues):
              </h4>
              <% if flash[:has_auto_correctable] %>
                <div class="mb-3 p-3 bg-yellow-50 border border-yellow-300 rounded-lg">
                  <div class="flex items-start">
                    <i class="fa-solid fa-lightbulb text-yellow-600 mt-0.5 mr-2"></i>
                    <div class="flex-1">
                      <p class="text-sm font-medium text-yellow-900 mb-1">
                        Some errors can be auto-corrected
                      </p>
                      <p class="text-xs text-yellow-800">
                        Values that exceed the maximum allowed will be automatically adjusted to the upper bound.
                        You can choose to apply these corrections or fix the file manually.
                      </p>
                    </div>
                  </div>
                </div>
              <% end %>
              <div class="max-h-96 overflow-y-auto border border-red-200 rounded-lg p-2">
                <% flash[:row_errors].each do |row_error| %>
                  <div class="mb-3 p-3 <%= row_error[:auto_correctable] ? 'bg-yellow-50 border-yellow-300' : 'bg-red-50 border-red-200' %> rounded border">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <strong class="<%= row_error[:auto_correctable] ? 'text-yellow-900' : 'text-red-900' %>">
                          Row <%= row_error[:row] %>:
                          <% if row_error[:auto_correctable] %>
                            <span class="text-xs font-normal text-yellow-700">(Auto-correctable)</span>
                          <% end %>
                        </strong>
                        <ul class="list-disc list-inside ml-4 mt-1 text-sm <%= row_error[:auto_correctable] ? 'text-yellow-800' : 'text-red-800' %>">
                          <% row_error[:errors].each do |error| %>
                            <li><%= error %></li>
                          <% end %>
                        </ul>
                        <% if row_error[:corrections] && row_error[:corrections].any? %>
                          <div class="mt-2 text-xs p-2 bg-white rounded border <%= row_error[:auto_correctable] ? 'border-yellow-300' : 'border-red-200' %>">
                            <strong class="<%= row_error[:auto_correctable] ? 'text-yellow-900' : 'text-red-900' %>">Corrections:</strong>
                            <ul class="list-disc list-inside ml-4 mt-1 <%= row_error[:auto_correctable] ? 'text-yellow-800' : 'text-red-800' %>">
                              <% row_error[:corrections].each do |field, value| %>
                                <li><%= field %>: <%= value %></li>
                              <% end %>
                            </ul>
                          </div>
                        <% end %>
                        <% if row_error[:data] %>
                          <div class="text-xs mt-2 p-2 bg-white rounded border <%= row_error[:auto_correctable] ? 'border-yellow-300' : 'border-red-200' %> <%= row_error[:auto_correctable] ? 'text-yellow-700' : 'text-red-700' %> font-mono">
                            <strong>Row data:</strong> <%= row_error[:data].inspect %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- CSV Format Instructions -->
  <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
    <h3 class="text-lg font-semibold text-blue-900 mb-3 flex items-center">
      <i class="fa-solid fa-info-circle mr-2"></i>
      CSV Format Requirements
    </h3>
    <div class="text-sm text-blue-800 space-y-2">
      <p>Your CSV file must include the following columns (in any order):</p>
      <ul class="list-disc list-inside ml-4 space-y-1">
        <li><strong>shipping_method</strong> - Name of an existing shipping method</li>
        <li><strong>country</strong> - 2-letter country code (e.g., US, CA, MX)</li>
        <li><strong>region</strong> - <em>(Optional)</em> State/province code (e.g., CA, NY, ON, BC) - leave blank for country-level rates</li>
        <li><strong>min_range_lbs</strong> - Minimum weight in pounds (must start at 0 for each location)</li>
        <li><strong>max_range_lbs</strong> - Maximum weight in pounds</li>
        <li><strong>flat_rate</strong> - Shipping cost in dollars</li>
        <li><strong>min_charge</strong> - Minimum charge in dollars</li>
      </ul>
    </div>
  </div>

  <!-- Example CSV -->
  <div class="bg-gray-50 border border-gray-200 rounded-xl p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
      <i class="fa-solid fa-file-csv mr-2"></i>
      Example CSV Format
    </h3>
    <div class="bg-white p-4 rounded border border-gray-300 overflow-x-auto">
      <pre class="text-xs font-mono text-gray-800">shipping_method,country,region,min_range_lbs,max_range_lbs,flat_rate,min_charge
Express Shipping,US,CA,0,5,9.99,5.00
Express Shipping,US,CA,5,10,14.99,10.00
Express Shipping,US,NY,0,5,12.99,8.00
Standard Shipping,CA,ON,0,10,15.99,10.00
Economy Shipping,US,,0,25,4.99,2.00</pre>
    </div>
    <div class="mt-3">
      <button onclick="downloadSampleCSV()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
        <i class="fa-solid fa-download mr-1"></i>
        Download Sample CSV
      </button>
    </div>
  </div>

  <!-- Upload Form -->
  <%= form_with url: process_import_rate_tables_path, multipart: true, local: true, class: "space-y-6", id: "import-form" do |form| %>
    <%= hidden_field_tag :apply_corrections, "false", id: "apply_corrections" %>
    <% if session[:csv_import_file_path].present? %>
      <%= hidden_field_tag :csv_import_file_path, session[:csv_import_file_path], id: "csv_import_file_path" %>
    <% end %>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Select CSV File
      </label>
      <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-xl hover:border-blue-400 transition-colors">
        <div class="space-y-1 text-center">
          <i class="fa-solid fa-cloud-arrow-up text-4xl text-gray-400 mb-3"></i>
          <div class="flex text-sm text-gray-600">
            <label for="csv_file" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
              <span>Upload a file</span>
              <%= file_field_tag :csv_file, accept: ".csv", class: "sr-only", id: "csv_file", required: true %>
            </label>
            <p class="pl-1">or drag and drop</p>
          </div>
          <p class="text-xs text-gray-500">CSV files only</p>
        </div>
      </div>
      <div id="file-name" class="mt-2 text-sm text-gray-600"></div>
    </div>

    <div class="flex justify-end space-x-4 pt-6">
      <%= link_to "Cancel", rate_tables_path, class: "px-6 py-3 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200", data: { turbo_frame: "_top" } %>
      <%= form.submit "Import Rates", class: "px-6 py-3 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors duration-200" %>
    </div>
  <% end %>
</div>

<script>
// Show selected file name
document.getElementById('csv_file').addEventListener('change', function(e) {
  const fileName = e.target.files[0]?.name;
  const fileNameDisplay = document.getElementById('file-name');
  if (fileName) {
    fileNameDisplay.textContent = 'Selected file: ' + fileName;
    fileNameDisplay.classList.add('font-medium', 'text-blue-600');
  }
});

// Download sample CSV
function downloadSampleCSV() {
  const csvContent = `shipping_method,country,region,min_range_lbs,max_range_lbs,flat_rate,min_charge
Express Shipping,US,CA,0,5,9.99,5.00
Express Shipping,US,CA,5,10,14.99,10.00
Express Shipping,US,CA,10,25,24.99,15.00
Express Shipping,US,NY,0,5,12.99,8.00
Express Shipping,US,NY,5,10,17.99,12.00
Standard Shipping,US,CA,0,10,5.99,3.00
Standard Shipping,US,CA,10,25,9.99,5.00
Standard Shipping,CA,ON,0,10,15.99,10.00
Standard Shipping,CA,ON,10,25,22.99,15.00
Standard Shipping,CA,BC,0,10,18.99,12.00
Economy Shipping,US,,0,25,4.99,2.00
Economy Shipping,CA,,0,25,6.99,3.00`;

  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.setAttribute('hidden', '');
  a.setAttribute('href', url);
  a.setAttribute('download', 'rate_import_sample.csv');
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// Confirm and apply auto-corrections
function confirmAutoCorrections() {
  // Set the apply_corrections flag and submit the form
  document.getElementById('apply_corrections').value = 'true';
  document.getElementById('import-form').submit();
}

// Dismiss toast notification
function dismissToast() {
  const toast = document.getElementById('auto-correct-toast');
  if (toast) {
    toast.style.display = 'none';
  }
}
</script>
  </div>
<% end %>

