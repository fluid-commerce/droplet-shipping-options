<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
  <% if @shipping_option %>
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Rate Tables for <%= @shipping_option.name %></h2>
        <p class="text-gray-600">Manage pricing rules for different regions and weight ranges</p>
      </div>
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
          <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
          <%= @shipping_option.status.capitalize %>
        </span>
      </div>
    </div>
  <% else %>
    <div class="flex items-center justify-between mb-8">
      <div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Rate Tables</h2>
        <p class="text-gray-600">Configure pricing for different shipping methods and regions</p>
      </div>
      <div class="flex items-center gap-3">
        <%= link_to import_rate_tables_path, class: "inline-flex items-center px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-medium rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105", data: { turbo_frame: "_top" } do %>
          <i class="fa-solid fa-file-import mr-2"></i>
          Import CSV
        <% end %>
        <% if @shipping_options.any? %>
          <%= link_to new_rate_table_path, class: "inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-medium rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105", data: { turbo_frame: "_top" } do %>
            <i class="fa-solid fa-plus mr-2"></i>
            Add Rate Table
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <% unless @shipping_option %>
    <!-- Filters Section -->
    <div class="mb-6 bg-gray-50 rounded-xl p-6 border border-gray-200">
      <%= form_with url: rate_tables_path, method: :get, local: true, class: "space-y-4" do |f| %>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
          <!-- Shipping Method Filter -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Shipping Method</label>
            <%= select_tag :shipping_method,
                options_for_select([["All Methods", ""]] + @shipping_options.map { |so| [so.name, so.id] }, params[:shipping_method]),
                class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" %>
          </div>

          <!-- Country Filter -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
            <%= select_tag :country,
                options_for_select([["All Countries", ""]] + @countries.map { |c| [c, c] }, params[:country]),
                class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" %>
          </div>

          <!-- Region Filter -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Region</label>
            <%= select_tag :region,
                options_for_select([["All Regions", ""]] + @regions.map { |r| [r, r] }, params[:region]),
                class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" %>
          </div>

          <!-- Min Weight Filter -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Min Weight (lbs)</label>
            <%= number_field_tag :weight_min, params[:weight_min],
                placeholder: "Min weight",
                class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" %>
          </div>

          <!-- Max Weight Filter -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Max Weight (lbs)</label>
            <%= number_field_tag :weight_max, params[:weight_max],
                placeholder: "Max weight",
                class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" %>
          </div>
        </div>

        <div class="flex gap-3">
          <%= f.submit "Apply Filters", class: "inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-medium rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105" %>
          <%= link_to "Clear Filters", rate_tables_path, class: "inline-flex items-center px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-xl transition-all duration-200" %>
        </div>
      <% end %>
    </div>

    <div class="overflow-x-auto">
      <% if @rates&.any? %>
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shipping Method</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Country</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Region</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Weight Range</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Flat Rate</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Min Charge</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @rates.each do |rate| %>
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center mr-3">
                      <i class="fa-solid fa-truck text-white text-sm"></i>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-900"><%= rate.shipping_option.name %></div>
                      <div class="text-sm text-gray-500"><%= rate.shipping_option.countries&.join(', ') || '-' %></div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <%= rate.country %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <%= rate.region.present? ? rate.region : "-" %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <%= rate.weight_range %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">
                  $<%= number_with_precision(rate.flat_rate, precision: 2) %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600">
                  $<%= number_with_precision(rate.min_charge, precision: 2) %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <%= link_to edit_rate_table_path(rate), class: "text-blue-600 hover:text-blue-900 mr-3", data: { turbo_frame: "_top" } do %>
                    Edit
                  <% end %>
                  <button class="delete-rate-btn text-red-600 hover:text-red-900"
                          style: "color: #dc2626 !important;"
                          data-rate-id="<%= rate.id %>"
                          data-rate-country="<%= rate.country %>"
                          data-rate-region="<%= rate.region %>"
                          data-shipping-option-name="<%= rate.shipping_option.name %>"
                          data-delete-url="<%= rate_table_path(rate) %>">
                    Delete
                  </button>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="mt-6 flex flex-col sm:flex-row items-center justify-between border-t border-gray-200 pt-6 gap-4">
          <div class="text-sm text-gray-700">
            Showing <span class="font-medium"><%= @pagy.from %></span> to <span class="font-medium"><%= @pagy.to %></span> of <span class="font-medium"><%= @pagy.count %></span> results
          </div>
          <div class="pagy-nav">
            <%== pagy_nav(@pagy, aria_label: 'Rate tables pagination', params: { shipping_method: params[:shipping_method], country: params[:country], region: params[:region], weight_min: params[:weight_min], weight_max: params[:weight_max] }.compact) %>
          </div>
        </div>
      <% else %>
        <div class="text-center py-12">
          <div class="mx-auto h-12 w-12 text-gray-400">
            <i class="fa-solid fa-table text-4xl"></i>
          </div>
          <h3 class="mt-2 text-sm font-medium text-gray-900">No rate tables found</h3>
          <p class="mt-1 text-sm text-gray-500">Import a CSV file or add rate tables manually to get started.</p>
          <div class="mt-6 flex gap-3 justify-center">
            <%= link_to import_rate_tables_path, class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 transition-colors duration-200", data: { turbo_frame: "_top" } do %>
              <i class="fa-solid fa-file-import mr-2"></i>
              Import CSV
            <% end %>
            <% if @shipping_options.any? %>
              <%= link_to new_rate_table_path, class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-200", data: { turbo_frame: "_top" } do %>
                <i class="fa-solid fa-plus mr-2"></i>
                Add Rate Table
              <% end %>
            <% else %>
              <%= link_to shipping_methods_shipping_options_path, class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-violet-600 hover:bg-violet-700 transition-colors duration-200" do %>
                <i class="fa-solid fa-plus mr-2"></i>
                Create Shipping Method
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<script>
// Global event delegation for delete rate buttons - only add once
if (!window.rateDeleteListenersAdded) {
  window.rateDeleteListenersAdded = true;
  
  // Handle delete rate table functionality
  document.addEventListener('click', function(event) {
    if (event.target.classList.contains('delete-rate-btn')) {
      event.preventDefault();

      const rateId = event.target.dataset.rateId;
      const country = event.target.dataset.rateCountry;
      const region = event.target.dataset.rateRegion;
      const shippingOptionName = event.target.dataset.shippingOptionName;
      const deleteUrl = event.target.dataset.deleteUrl;

      const regionText = region ? ` (${region})` : '';
      const confirmMessage = `Are you sure you want to delete this rate table?\n\nShipping Method: ${shippingOptionName}\nCountry: ${country}${regionText}`;
      
      if (confirm(confirmMessage)) {
        deleteRate(deleteUrl);
      }
    }
  });

  function deleteRate(deleteUrl) {
    const form = document.createElement('form');
    form.method = 'post';
    form.action = deleteUrl;

    const methodField = document.createElement('input');
    methodField.type = 'hidden';
    methodField.name = '_method';
    methodField.value = 'delete';
    form.appendChild(methodField);

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const csrfField = document.createElement('input');
    csrfField.type = 'hidden';
    csrfField.name = 'authenticity_token';
    csrfField.value = csrfToken;
    form.appendChild(csrfField);

    document.body.appendChild(form);
    form.submit();
  }
}
</script>